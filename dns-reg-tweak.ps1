#Powershell script to change the registry key in all domain controllers to add in the MS recommended mitigation against CVE-2020-1350
#This doesn't mean that you should not patch. This is a workaround only.

#What is CVE-2020-1350? Have a read here -> https://blog.gdwnet.com/2020/07/15/sigred-dns-flaw-summary/

#Questions? Issues? Suggestions? contact@gdwnet.com
#Useful? If so, why not buy me a coffee to say thanks? https://www.buymeacoffee.com/garyw

#You can set the domain and domain admin user here, this is used by the "enter pssession" command further down the script

$domainname="MyDomain"
$adminuser="Administrator"

#Grab all the domain controllers for the domain
$adcs=(Get-ADForest).Domains | foreach-object { Get-ADDomainController -Filter * -Server $_ }
$credential = Get-Credential -Credential $domainname\$adminuser

#Loop through all the domain controllers
ForEach ($dc in $adcs)
{
	Write-output "Setting registry key on " $dc.hostname
	$remotesession=New-PSSession -ComputerName $dc.hostname -Credential $credential
	invoke-command -session $remotesession -scriptblock {New-ItemProperty -Path HKLM:\SYSTEM\CurrentControlSet\Services\DNS\Parameters -Name "TcpReceivePacketSize" -Value 0xFF00 -PropertyType "DWord" -force}
	invoke-command -session $remotesession -scriptblock {Restart-Service DNS}
	Remove-PSSession $remotesession
	write-output "Update complete for " $dc.hostname
	write-output "---------------------------------------"
}

write-output "Task Complete"
